.querySelector('.radio-button');
                if (option.dataset.urgency === urgency) {
                    option.classList.add('selected');
                    radio.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                    radio.classList.remove('selected');
                }
            });
            
            // Show/hide emergency note
            elements.emergencyNote.style.display = urgency === 'emergency' ? 'flex' : 'none';
            
            validateForm();
        }

        function addPhoto() {
            if (state.photos.length >= 4) {
                showToast('Maximum 4 photos allowed', 'error');
                return;
            }
            
            const photoId = `photo_${Date.now()}`;
            state.photos.push({ id: photoId, url: null, uploading: true });
            
            // Create photo slot
            const slot = document.createElement('div');
            slot.className = 'photo-slot has-photo';
            slot.dataset.id = photoId;
            slot.innerHTML = `
                <div class="photo-progress">Uploading...</div>
                <div class="photo-delete">×</div>
            `;
            
            // Replace add button or insert before it
            const addButton = elements.photoGrid.querySelector('.photo-slot.add');
            if (addButton) {
                elements.photoGrid.insertBefore(slot, addButton);
            } else {
                elements.photoGrid.appendChild(slot);
            }
            
            // Simulate upload
            setTimeout(() => {
                const photo = state.photos.find(p => p.id === photoId);
                if (photo) {
                    photo.uploading = false;
                    photo.url = `https://via.placeholder.com/64/2E86AB/FFFFFF?text=Photo${state.photos.length}`;
                    slot.style.backgroundImage = `url(${photo.url})`;
                    slot.querySelector('.photo-progress').remove();
                }
            }, 1000 + Math.random() * 1000);
            
            // Add new add button if needed
            if (state.photos.length < 4 && !elements.photoGrid.querySelector('.photo-slot.add')) {
                const newAddButton = document.createElement('div');
                newAddButton.className = 'photo-slot add';
                newAddButton.innerHTML = `
                    <div style="font-size: 20px; margin-bottom: 4px;">+</div>
                    <div>Add</div>
                `;
                newAddButton.addEventListener('click', addPhoto);
                elements.photoGrid.appendChild(newAddButton);
            }
            
            validateForm();
        }

        function deletePhoto(photoId) {
            state.photos = state.photos.filter(p => p.id !== photoId);
            
            // Remove slot
            const slot = elements.photoGrid.querySelector(`[data-id="${photoId}"]`);
            if (slot) slot.remove();
            
            // Ensure add button exists
            if (!elements.photoGrid.querySelector('.photo-slot.add')) {
                const addButton = document.createElement('div');
                addButton.className = 'photo-slot add';
                addButton.innerHTML = `
                    <div style="font-size: 20px; margin-bottom: 4px;">+</div>
                    <div>Add</div>
                `;
                addButton.addEventListener('click', addPhoto);
                elements.photoGrid.appendChild(addButton);
            }
            
            validateForm();
        }

        function setLanguage(lang) {
            state.language = lang;
            
            // Update language toggle
            elements.languageOptions.forEach(option => {
                if (option.dataset.lang === lang) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            updateUI();
        }

        function updateUI() {
            const t = translations[state.language];
            
            // Update all text elements
            elements.navTitle.textContent = t.navTitle;
            elements.screenTitle.textContent = t.screenTitle;
            elements.categoryLabel.textContent = t.categoryLabel;
            if (!state.category) {
                elements.categoryText.textContent = t.categoryPlaceholder;
            }
            elements.descriptionLabel.textContent = t.descriptionLabel;
            elements.descriptionField.placeholder = t.descriptionPlaceholder;
            elements.photosLabel.textContent = t.photosLabel;
            elements.photosHelper.textContent = t.photosHelper;
            elements.urgencyLabel.textContent = t.urgencyLabel;
            elements.routineTitle.textContent = t.routineTitle;
            elements.routineSubtext.textContent = t.routineSubtext;
            elements.urgentTitle.textContent = t.urgentTitle;
            elements.urgentSubtext.textContent = t.urgentSubtext;
            elements.emergencyTitle.textContent = t.emergencyTitle;
            elements.emergencySubtext.textContent = t.emergencySubtext;
            elements.emergencyText.innerHTML = t.emergencyText;
            elements.footerNote.textContent = t.footerNote;
            elements.submitText.textContent = t.submitText;
            
            // Update categories
            setupCategories();
            
            // Update category text if selected
            if (state.category) {
                const category = t.categories.find(c => c.id === state.category);
                if (category) {
                    elements.categoryText.textContent = category.name;
                }
            }
        }

        function validateForm() {
            const hasCategory = !!state.category;
            const hasDescription = state.description.trim().length >= 10;
            const hasPhotos = state.photos.length > 0;
            const hasUrgency = !!state.urgency;
            
            // At least one of category, description (10+ chars), or photo required
            const hasContent = hasCategory || hasDescription || hasPhotos;
            const isValid = hasContent && hasUrgency;
            
            elements.submitButton.disabled = !isValid || state.isSubmitting;
            
            return isValid;
        }

        function hasUnsavedChanges() {
            return state.category || state.description.trim() || state.photos.length > 0;
        }

        async function submitForm() {
            if (!validateForm() || state.isSubmitting) return;
            
            state.isSubmitting = true;
            elements.submitButton.disabled = true;
            elements.submitButton.classList.add('loading');
            elements.submitText.textContent = translations[state.language].submittingText;
            
            // Prepare form data
            state.formData = {
                category: state.category,
                description: state.description,
                photos: state.photos.filter(p => !p.uploading).map(p => p.url),
                urgency: state.urgency,
                language: state.language,
                timestamp: new Date().toISOString(),
                location: { latitude: 25.7617, longitude: -80.1918 } // Miami coordinates
            };
            
            try {
                // Simulate API call
                await simulateApiCall(state.formData);
                
                // Success
                showToast('Issue submitted successfully!', 'success');
                
                // Show confirmation modal
                setTimeout(() => {
                    showModal(
                        '✅ Issue Reported',
                        `Your maintenance request has been submitted.<br><br>
                        <strong>Ticket #:</strong> BMA-${Math.floor(1000 + Math.random() * 9000)}-2026<br>
                        <strong>Status:</strong> Submitted<br>
                        <strong>Estimated Response:</strong> ${getEstimatedResponse(state.urgency)}<br><br>
                        You will receive SMS updates on the repair status.`,
                        [
                            { 
                                text: 'View Status', 
                                action: () => {
                                    console.log('Navigated to status screen');
                                    resetForm();
                                }
                            },
                            { 
                                text: 'Done', 
                                action: () => {
                                    resetForm();
                                }
                            }
                        ]
                    );
                }, 500);
                
            } catch (error) {
                // Error
                showToast('Submission failed. Please try again.', 'error');
                console.error('Submission error:', error);
            } finally {
                state.isSubmitting = false;
                elements.submitButton.classList.remove('loading');
                elements.submitText.textContent = translations[state.language].submitText;
                validateForm();
            }
        }

        function simulateApiCall(data) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Simulate network error 10% of the time
                    if (Math.random() < 0.1) {
                        reject(new Error('Network error'));
                    } else {
                        resolve({
                            success: true,
                            ticketId: `BMA-${Math.floor(1000 + Math.random() * 9000)}-2026`,
                            timestamp: new Date().toISOString()
                        });
                    }
                }, 1500);
            });
        }

        function getEstimatedResponse(urgency) {
            switch(urgency) {
                case 'emergency': return 'Within 2 hours';
                case 'urgent': return 'Within 24 hours';
                case 'routine': return 'Within 3-5 business days';
                default: return 'Soon';
            }
        }

        function resetForm() {
            state.category = '';
            state.description = '';
            state.photos = [];
            state.urgency = 'routine';
            state.isSubmitting = false;
            
            // Reset UI
            elements.categoryText.textContent = translations[state.language].categoryPlaceholder;
            elements.descriptionField.value = '';
            elements.charCounter.textContent = '0/500 characters';
            elements.charCounter.className = 'char-counter';
            elements.photoGrid.innerHTML = `
                <div class="photo-slot add">
                    <div style="font-size: 20px; margin-bottom: 4px;">+</div>
                    <div>Add</div>
                </div>
            `;
            selectUrgency('routine');
            elements.emergencyNote.style.display = 'none';
            
            // Re-add event listeners
            elements.photoGrid.querySelector('.photo-slot.add').addEventListener('click', addPhoto);
            
            validateForm();
        }

        // ========== UI COMPONENTS ==========
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showModal(title, message, buttons) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-icon">${title.includes('✅') ? '✅' : title.includes('❌') ? '❌' : 'ℹ️'}</div>
                    <div class="modal-title">${title}</div>
                    <div class="modal-message">${message}</div>
                    <div class="modal-actions">
                        ${buttons.map((btn, i) => `
                            <button class="modal-button ${i === 0 ? 'primary' : 'secondary'}" data-action="${i}">
                                ${btn.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners to buttons
            modal.querySelectorAll('.modal-button').forEach((button, index) => {
                button.addEventListener('click', () => {
                    buttons[index].action();
                    modal.remove();
                });
            });
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ========== SIT TEST FUNCTIONS ==========
        function runTest(testName) {
            const test = SIT_TESTS[testName];
            if (!test) return;
            
            console.log(`Running SIT Test: ${testName}`);
            
            // Reset form
            resetForm();
            
            // Set language if specified
            if (test.language) {
                setLanguage(test.language);
            }
            
            // Set category
            if (test.category) {
                setTimeout(() => selectCategory(test.category), 100);
            }
            
            // Set description
            if (test.description) {
                elements.descriptionField.value = test.description;
                handleDescriptionInput();
            }
            
            // Add photos
            if (test.photos > 0) {
                for (let i = 0; i < test.photos; i++) {
                    setTimeout(() => addPhoto(), 200 * (i + 1));
                }
            }
            
            // Set urgency
            if (test.urgency) {
                setTimeout(() => selectUrgency(test.urgency), 500);
            }
            
            // Simulate error if specified
            if (test.simulateError) {
                // Override simulateApiCall for this test
                const originalSimulateApiCall = simulateApiCall;
                simulateApiCall = () => Promise.reject(new Error('Simulated network error'));
                
                setTimeout(() => {
                    elements.submitButton.click();
                    setTimeout(() => {
                        simulateApiCall = originalSimulateApiCall;
                    }, 2000);
                }, 1000);
            }
            
            // Log test state
            setTimeout(() => {
                console.log(`Test ${testName} state:`, {
                    category: state.category,
                    descriptionLength: state.description.length,
                    photos: state.photos.length,
                    urgency: state.urgency,
                    isValid: validateForm(),
                    language: state.language
                });
            }, 1000);
        }

        // ========== INITIAL SETUP ==========
        // Setup photo grid event delegation
        elements.photoGrid.addEventListener('click', (e) => {
            const addButton = e.target.closest('.photo-slot.add');
            const deleteButton = e.target.closest('.photo-delete');
            const photoSlot = e.target.closest('.photo-slot.has-photo');
            
            if (addButton) {
                addPhoto();
            } else if (deleteButton) {
                const photoId = deleteButton.closest('.photo-slot').dataset.id;
                deletePhoto(photoId);
            } else if (photoSlot && !deleteButton) {
                // Show photo preview
                const photo = state.photos.find(p => p.id === photoSlot.dataset.id);
                if (photo && photo.url) {
                    showModal('Photo Preview', `<img src="${photo.url}" style="max-width:100%; border-radius:8px;">`, [
                        { text: 'Close', action: () => {} }
                    ]);
                }
            }
        });

        // Setup category dropdown event delegation
        elements.categoryDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.dropdown-item');
            if (item) {
                selectCategory(item.dataset.id);
            }
        });

        // Initialize
        init();
        
        // Setup initial photo add button
        elements.photoGrid.querySelector('.photo-slot.add').addEventListener('click', addPhoto);
    </script>
</body>
</html>